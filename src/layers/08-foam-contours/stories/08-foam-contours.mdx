# Foam Contours (Marching Squares)

Foam is rendered using the marching squares algorithm to extract smooth contours
from a 2D intensity grid. Multiple threshold levels create nested contour rings:
- **Outer ring** (low threshold, thin line) - light foam edges
- **Middle ring** (medium threshold) - moderate foam density
- **Inner ring** (high threshold, thick line) - dense foam cores

import { Filmstrip } from '@stories/components/Filmstrip';
import { extractLineSegments, boxBlur } from '@src/render/marchingSquares';
import { FOAM_THRESHOLDS_BASE } from '@src/render/foamConfig';
import {
  FOAM_STRIP_BASIC,
  FOAM_STRIP_ADVANCED,
  FOAM_STRIP_EDGE_CASES,
  FOAM_STRIP_NO_BLUR,
  FOAM_STRIP_HIGH_BLUR,
} from '../progressions';

export const BACKGROUND_COLOR = '#1a4a6e';

export function renderFoamContour(snap, ctx, w, h, blurPasses = 1) {
  // Fill background
  ctx.fillStyle = BACKGROUND_COLOR;
  ctx.fillRect(0, 0, w, h);

  // Apply blur if needed
  const blurred = blurPasses > 0
    ? boxBlur(snap.grid, snap.width, snap.height, blurPasses)
    : snap.grid;

  // Sort thresholds low to high so outer contours draw first
  const sortedThresholds = [...FOAM_THRESHOLDS_BASE].sort((a, b) => a.value - b.value);

  // Draw contours for each threshold
  for (const { value, color, lineWidth } of sortedThresholds) {
    const segments = extractLineSegments(blurred, snap.width, snap.height, value);

    ctx.strokeStyle = color;
    ctx.lineWidth = lineWidth;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    ctx.beginPath();
    for (const seg of segments) {
      ctx.moveTo(seg.x1 * w, seg.y1 * h);
      ctx.lineTo(seg.x2 * w, seg.y2 * h);
    }
    ctx.stroke();
  }
}

export const renderFoamDefault = (snap, ctx, w, h) => renderFoamContour(snap, ctx, w, h, 1);
export const renderFoamNoBlur = (snap, ctx, w, h) => renderFoamContour(snap, ctx, w, h, 0);
export const renderFoamHighBlur = (snap, ctx, w, h) => renderFoamContour(snap, ctx, w, h, 3);

<section id="basic-shapes">

## Basic Shapes

These test cases verify the marching squares algorithm handles fundamental shapes:

1. **Single Circle** - A round foam patch with intensity falloff from center
1. **Overlapping** - Two circles that merge where they touch
1. **Wave Line** - Horizontal line simulating breaking wave foam

<Filmstrip snapshots={FOAM_STRIP_BASIC.snapshots} renderSnapshot={renderFoamDefault} testId={FOAM_STRIP_BASIC.testId} />

**What to look for:**
- Contour lines form smooth curves, not jagged steps
- Overlapping regions merge cleanly into one shape
- Three distinct threshold levels visible (thin outer, medium middle, thick inner)

</section>

<section id="advanced-patterns">

## Advanced Patterns

More complex scenarios that stress the algorithm:

1. **Nested Levels** - Concentric rings of increasing intensity
1. **Scattered** - Multiple separate foam patches
1. **Edge Foam** - Foam touching grid boundaries

<Filmstrip snapshots={FOAM_STRIP_ADVANCED.snapshots} renderSnapshot={renderFoamDefault} testId={FOAM_STRIP_ADVANCED.testId} />

**What to look for:**
- Nested contours show all three threshold levels as distinct rings
- Scattered patches render as separate closed shapes
- Edge foam correctly clips at boundaries without artifacts

</section>

<section id="edge-cases">

## Edge Cases

Boundary conditions the algorithm must handle gracefully:

1. **Empty** - No foam data (should produce no contours)
1. **Full** - All cells above threshold (no contour lines visible)

<Filmstrip snapshots={FOAM_STRIP_EDGE_CASES.snapshots} renderSnapshot={renderFoamDefault} testId={FOAM_STRIP_EDGE_CASES.testId} />

**What to look for:**
- Empty grid shows only the ocean background
- Full saturation shows solid color with no contour lines

</section>

<section id="blur-comparison">

## Blur Effect

The box blur smooths the intensity grid before contour extraction.
More blur passes create softer, rounder contours.

<Filmstrip snapshots={FOAM_STRIP_NO_BLUR.snapshots} renderSnapshot={renderFoamNoBlur} testId={FOAM_STRIP_NO_BLUR.testId} />

**No blur (0 passes)** - Sharp, angular contours following grid cells

<Filmstrip snapshots={FOAM_STRIP_HIGH_BLUR.snapshots} renderSnapshot={renderFoamHighBlur} testId={FOAM_STRIP_HIGH_BLUR.testId} />

**High blur (3 passes)** - Smooth, organic contours

</section>
