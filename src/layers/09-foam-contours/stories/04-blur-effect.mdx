# Blur Effect

import { Filmstrip } from '@stories/components/Filmstrip';
import { extractLineSegments, boxBlur } from '@src/render/marchingSquares';
import { FOAM_THRESHOLDS_BASE } from '@src/render/foamConfig';
import { FOAM_STRIP_NO_BLUR, FOAM_STRIP_HIGH_BLUR } from './04-blur-effect';

export const BACKGROUND_COLOR = '#1a4a6e';

export function renderFoamContour(snap, ctx, w, h, blurPasses = 1) {
  ctx.fillStyle = BACKGROUND_COLOR;
  ctx.fillRect(0, 0, w, h);

  const blurred = blurPasses > 0
    ? boxBlur(snap.grid, snap.width, snap.height, blurPasses)
    : snap.grid;

  const sortedThresholds = [...FOAM_THRESHOLDS_BASE].sort((a, b) => a.value - b.value);

  for (const { value, color, lineWidth } of sortedThresholds) {
    const segments = extractLineSegments(blurred, snap.width, snap.height, value);
    ctx.strokeStyle = color;
    ctx.lineWidth = lineWidth;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.beginPath();
    for (const seg of segments) {
      ctx.moveTo(seg.x1 * w, seg.y1 * h);
      ctx.lineTo(seg.x2 * w, seg.y2 * h);
    }
    ctx.stroke();
  }
}

export const renderFoamNoBlur = (snap, ctx, w, h) => renderFoamContour(snap, ctx, w, h, 0);
export const renderFoamHighBlur = (snap, ctx, w, h) => renderFoamContour(snap, ctx, w, h, 3);

**No blur (0 passes)** - Sharp, angular contours:

<Filmstrip snapshots={FOAM_STRIP_NO_BLUR.snapshots} renderSnapshot={renderFoamNoBlur} testId={FOAM_STRIP_NO_BLUR.testId} />

**High blur (3 passes)** - Smooth, organic contours:

<Filmstrip snapshots={FOAM_STRIP_HIGH_BLUR.snapshots} renderSnapshot={renderFoamHighBlur} testId={FOAM_STRIP_HIGH_BLUR.testId} />
