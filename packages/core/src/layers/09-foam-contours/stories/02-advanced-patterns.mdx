# Advanced Patterns

import { Filmstrip } from '@stories/components/Filmstrip';
import { extractLineSegments, boxBlur } from '@src/render/marchingSquares';
import { FOAM_THRESHOLDS_BASE } from '@src/render/foamConfig';
import { FOAM_STRIP_ADVANCED } from './02-advanced-patterns';

export const BACKGROUND_COLOR = '#1a4a6e';

export function renderFoamContour(snap, ctx, w, h, blurPasses = 1) {
  ctx.fillStyle = BACKGROUND_COLOR;
  ctx.fillRect(0, 0, w, h);

  const blurred = blurPasses > 0
    ? boxBlur(snap.grid, snap.width, snap.height, blurPasses)
    : snap.grid;

  const sortedThresholds = [...FOAM_THRESHOLDS_BASE].sort((a, b) => a.value - b.value);

  for (const { value, color, lineWidth } of sortedThresholds) {
    const segments = extractLineSegments(blurred, snap.width, snap.height, value);
    ctx.strokeStyle = color;
    ctx.lineWidth = lineWidth;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.beginPath();
    for (const seg of segments) {
      ctx.moveTo(seg.x1 * w, seg.y1 * h);
      ctx.lineTo(seg.x2 * w, seg.y2 * h);
    }
    ctx.stroke();
  }
}

export const renderFoamDefault = (snap, ctx, w, h) => renderFoamContour(snap, ctx, w, h, 1);

<Filmstrip snapshots={FOAM_STRIP_ADVANCED.snapshots} renderSnapshot={renderFoamDefault} testId={FOAM_STRIP_ADVANCED.testId} />

Advanced patterns: nested levels, scattered patches, edge foam.
