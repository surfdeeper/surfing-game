# 6. Foam Grid

The foam grid accumulates density from energy transfer and persists over time.
Unlike the energy transfer grid (cleared each frame), the foam grid maintains
state as bubbles form, spread, and decay.

import { ProgressionPlayer } from '../components/ProgressionPlayer';
import { Filmstrip, renderMatrixToCanvas } from '../components/Filmstrip';
import { energyToColor } from '@src/render/colorScales';
import {
  FOAM_GRID_STRIP_ACCUMULATION,
  FOAM_GRID_STRIP_ADVECTION,
  FOAM_GRID_STRIP_COMBINED,
  PROGRESSION_ACCUMULATION,
  PROGRESSION_ADVECTION,
  PROGRESSION_COMBINED,
} from '@src/render/foamGridProgressions';

export const renderEnergy = (snap, ctx, w, h) =>
  renderMatrixToCanvas(ctx, snap.matrix, energyToColor, w, h);

<section id="accumulation">

## Foam Accumulation

Energy from the transfer grid is deposited into the foam grid each frame:

```js
foam[idx] = Math.min(1, foam[idx] + transfer[idx] * depositScale);
```

<ProgressionPlayer snapshots={PROGRESSION_ACCUMULATION.snapshots} />

<Filmstrip snapshots={FOAM_GRID_STRIP_ACCUMULATION.snapshots} renderSnapshot={renderEnergy} testId={FOAM_GRID_STRIP_ACCUMULATION.testId} />

**What to look for:**
- t=0s: Initial energy transfer deposit
- t=1-2s: Foam density builds as more energy arrives
- Foam caps at 1.0 (fully saturated)

</section>

<section id="advection">

## Shoreward Advection

Foam doesn't just accumulate - it drifts toward shore as the water moves:

```js
// Push fraction of each row into row below
const advectFactor = advectRate * dt;
foam[downIdx] += foam[idx] * advectFactor;
foam[idx] -= foam[idx] * advectFactor;
```

<ProgressionPlayer snapshots={PROGRESSION_ADVECTION.snapshots} />

<Filmstrip snapshots={FOAM_GRID_STRIP_ADVECTION.snapshots} renderSnapshot={renderEnergy} testId={FOAM_GRID_STRIP_ADVECTION.testId} />

**Parameters:**

| Parameter | Range | Effect |
|-----------|-------|--------|
| `advectRate` | 0 - 1.0 | Fraction of foam pushed shoreward per second |
| `decayRate` | 0 - 1.0 | Foam decay rate (bubbles popping) |
| `depositScale` | 0 - 1.0 | How much energy converts to foam |

</section>

<section id="combined">

## Combined Behavior

In practice, foam simultaneously accumulates at the breaking zone and advects shoreward:

<ProgressionPlayer snapshots={PROGRESSION_COMBINED.snapshots} />

<Filmstrip snapshots={FOAM_GRID_STRIP_COMBINED.snapshots} renderSnapshot={renderEnergy} testId={FOAM_GRID_STRIP_COMBINED.testId} />

**What to look for:**
- t=0s: Empty grid
- t=1-2s: Foam appears at breaking zone (row 3)
- t=3-5s: Foam drifts toward shore while new foam continues depositing
- Decay balances accumulation, reaching steady state

</section>

<section id="grid-vs-rendering">

## Grid vs Rendering

The foam grid stores raw density values (0-1). This grid is then:
1. **Sampled** for intensity-based rendering (alpha blending)
1. **Contoured** via marching squares for outline rendering

The next two layers show these different rendering approaches:
- **Foam Dispersion** (07) - How foam density changes over time
- **Foam Contours** (08) - How the marching squares algorithm extracts contour lines

</section>

<section id="data-structure">

## Data Structure

```typescript
interface FoamLayer {
  data: Float32Array;  // Foam density 0-1
  width: number;       // Grid columns
  height: number;      // Grid rows
}
```

The foam grid uses the same dimensions as the energy field, ensuring
all layers are spatially aligned for consistent sampling.

</section>
