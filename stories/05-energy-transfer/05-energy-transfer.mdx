# 5. Energy Transfer

When waves break, energy is **released** from the energy field and deposited into an
energy transfer grid. This grid captures where energy is actively being dissipated.

import { Filmstrip, renderMatrixToCanvas } from '../components/Filmstrip';
import { energyToColor } from '../../src/render/colorScales';
import {
  ENERGY_TRANSFER_STRIP_BREAKING,
  ENERGY_TRANSFER_STRIP_SPREAD,
} from '../../src/render/energyTransferProgressions';

export const renderEnergy = (snap, ctx, w, h) =>
  renderMatrixToCanvas(ctx, snap.matrix, energyToColor, w, h);

<section id="breaking-release">

## Breaking Energy Release

When a wave meets the breaking criterion (H > 0.78d), energy drains from the energy
field into the transfer grid. The `drainEnergyAt()` function removes energy at the
breaking location:

```js
const drained = drainEnergyAt(energyField, x, y, amount);
accumulateEnergyTransfer(transferGrid, x, y, drained);
```

<Filmstrip snapshots={ENERGY_TRANSFER_STRIP_BREAKING.snapshots} renderSnapshot={renderEnergy} testId={ENERGY_TRANSFER_STRIP_BREAKING.testId} />

**What to look for:**
- Energy appears where waves are actively breaking
- Transfer grid shows instantaneous energy release (not accumulated foam)
- Values are cleared each frame after depositing into foam grid

</section>

<section id="spatial-spread">

## Spatial Spread

The transfer grid can be blurred to spread the energy release over a wider area,
creating smoother foam deposits:

<Filmstrip snapshots={ENERGY_TRANSFER_STRIP_SPREAD.snapshots} renderSnapshot={renderEnergy} testId={ENERGY_TRANSFER_STRIP_SPREAD.testId} />

**Parameters:**
- `blurPasses`: Number of box-blur iterations (0 = sharp, 2+ = soft)
- Higher blur = wider, softer foam deposits
- Lower blur = concentrated foam at exact breaking point

</section>

<section id="data-flow">

## Data Flow

```
Energy Field → Breaking Detection → Energy Transfer Grid → Foam Grid
     ↑                                      ↓
  (source)                            (accumulator)
```

The energy transfer grid is a **per-frame accumulator**:
1. Each tick, breaking locations deposit drained energy
1. Foam grid reads from transfer and accumulates
1. Transfer grid is cleared after foam deposit
1. Foam grid persists and decays over time

This separation allows:
- Visualizing where energy is being released *right now*
- Decoupling breaking detection from foam accumulation
- Different rendering styles for instantaneous vs accumulated foam

</section>
