# Plan: Reactive Layer Dependencies

**Status**: Proposed
**Depends On**: None

## Problem

Debug panel toggles are independent - you can enable "Foam Zones" even when "Set Waves" is off, which makes no sense since foam is generated by waves. This creates confusion and wasted rendering cycles.

Current behavior:
- Turn off Set Waves + Background Waves
- Foam Zones toggle still appears "ON"
- Nothing renders (correct) but the toggle state is misleading

Desired behavior:
- Layers should be aware of their data dependencies
- When a parent layer is off, child layers should visually indicate they're inactive
- Could auto-disable, or show as "grayed out / no input"

## Layer Dependency Graph

```
Bathymetry (independent)
│
├── Set Waves ──────┐
│                   ├──→ Foam ──→ Foam Zones
├── Background ─────┘           → Foam Samples
│                               → Foam Options A/B/C
│
└── Player ──→ AI Player ──→ AI Mode (already reactive!)
```

## Proposed Solution

### Option A: Visual Indication (Minimal)
Show dependent layers as grayed-out when their input is unavailable. Keep the toggle state but indicate "no input".

```jsx
<Toggle
  label="Foam Zones"
  checked={toggles.showFoamZones}
  disabled={!hasWaveInput}  // grayed out, shows "no input"
  onChange={() => onToggle('showFoamZones')}
/>
```

Pros: Non-destructive, user intent preserved
Cons: Still clutters UI with inactive options

### Option B: Conditional Rendering (Current Pattern)
Extend the existing pattern used for AI Player - only show child toggles when parent is active.

```jsx
{hasWaveInput && (
  <Toggle label="Foam Zones" ... />
)}
```

Pros: Clean UI, already used for Player→AI Player
Cons: Toggle disappears entirely, might confuse users

### Option C: Computed Effective State
Toggles remain visible but compute an "effective" state that accounts for dependencies.

```js
const effectiveToggles = {
  ...toggles,
  showFoamZones: toggles.showFoamZones && hasWaveInput,
  showFoamSamples: toggles.showFoamSamples && hasWaveInput,
};
```

Pros: User preferences preserved, rendering correct
Cons: Toggle shows ON but nothing renders (current problem)

### Recommendation: Option A + B Hybrid
- Use conditional rendering (Option B) for clearly dependent layers
- Add visual "disabled" state for edge cases
- Group related toggles under collapsible parent

```jsx
<Section title="View Layers">
  <Toggle label="Bathymetry" ... />
  <Toggle label="Set Waves" ... />
  <Toggle label="Background" ... />

  {hasWaveInput && (
    <>
      <Toggle label="Foam Zones" ... />
      <Toggle label="Foam Samples" ... />
    </>
  )}

  <Toggle label="Player" ... />
  {toggles.showPlayer && (
    <>
      <Toggle label="AI Player" ... />
      {toggles.showAIPlayer && <Toggle label="AI Mode" ... />}
    </>
  )}
</Section>
```

## Implementation Steps

1. Define dependency helper in DebugPanel:
   ```js
   const hasWaveInput = toggles.showSetWaves || toggles.showBackgroundWaves;
   const hasFoamInput = hasWaveInput; // foam requires waves
   ```

1. Wrap foam toggles in conditional render

1. Move Foam Dispersion options under conditional (they also need foam)

1. Add CSS for nested/dependent toggles (subtle indent)

1. Update tests to verify conditional behavior

## Files Affected

- `src/ui/DebugPanel.jsx` - Add conditional rendering
- `src/ui/DebugPanel.css` - Optional indent styling
- `src/ui/DebugPanel.test.jsx` - Test dependency behavior

## Testing

1. Manual: Turn off Set Waves + Background → Foam toggles should hide
1. Manual: Turn on either wave type → Foam toggles reappear
1. Unit: Test that foam toggles don't render when waves are off
1. Visual: Verify no layout shift when toggles appear/disappear

## Future Considerations

- Could extend to rendering pipeline itself (skip foam computation when waves off)
- Could add "dependency badges" showing what each layer needs
- Could persist "preferred" state separately from "effective" state
